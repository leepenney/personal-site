<!DOCTYPE html><html lang="en-GB"><head><meta charset="utf-8"><title>Avoiding headaches with Go, Docker and fly.io &gt; Tech &gt; Lee Penney</title><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="description" content="I&#39;m putting this here mainly to remind myself in future, but also in case it pops up in a search conducted by a soul as perplexed as I was before it finally clicked.
I&#39;m new to Go and I took"><meta property="og:title" content="Avoiding headaches with Go, Docker and fly.io"><meta property="og:description" content="I&#39;m putting this here mainly to remind myself in future, but also in case it pops up in a search conducted by a soul as perplexed as I was before it finally clicked.
I&#39;m new to Go and I took"><meta property="og:url" content="https://www.leepenney.com/tech/avoiding-headaches-with-go-docker-and-flyio.html"><meta property="og:type" content="article"><link rel="canonical" href="https://www.leepenney.com/tech/avoiding-headaches-with-go-docker-and-flyio.html"><link rel="icon" href="https://www.leepenney.com/img/favicon.ico" type="image/x-icon"><style>body{color:#212121;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;letter-spacing:.02em;padding:0 20px;margin:0 auto;max-width:800px}a{color:#212121;text-decoration:none}dt{font-weight:700;font-size:1.2em}dt a{display:block;padding:10px 0 5px 0}dd,div.meta{margin:0 0 1em 0;color:#aaa;font-size:90%}code{font-family:monospace;font-size:120%}header{border-bottom:1px solid;padding:20px 0}header:after{content:"";display:table;clear:both}header svg{float:left;margin:0 10px 0 0}header nav,header span{vertical-align:middle}header nav{line-height:55px}header nav a{border-bottom:1px dotted}main{margin:20px 0}main.home section{display:grid;grid-template-columns:1fr 1fr;grid-auto-rows:calc((100vw - 40px)/ 2);column-gap:10px;row-gap:10px;margin:0 0 3em 0;grid-template-rows:2em}.cat-block{display:block;color:#fff;background:#212121;text-decoration:none;text-align:center;line-height:calc((100vw - 40px)/ 2)}.cat-block:nth-child(1){grid-column-start:1;grid-column-end:3;line-height:normal;color:#212121;background:#fff}span.tag{background:#eaedee;display:inline-block;margin:0 7px 0 0;border-radius:5px;padding:0 10px}main.books dl{padding:0 0 0 90px}main.books dd:after{content:"";display:table;clear:both}main.books dl img{height:120px;width:80px;float:left;margin:-1.6em 0 0 -90px}article img{max-width:100%;height:auto}article hr{display:none}article table{border-collapse:collapse;border:none!important;margin:1em auto}article tr{border-bottom:1px dotted}article td,article th{border:none!important;padding:.5em 1em}article li{margin:0 0 1em 0}article a{border-bottom:1px dotted}main.book article img{height:180px;width:120px;display:block;margin:0 1em 0 0;float:left}main.book article p:first-of-type+ul{list-style-type:none;float:left;padding:0;width:120px;margin:1em 1em 1em 0;font-size:90%;clear:left;text-transform:uppercase;text-align:center}main.book article ul a{display:block;background:#000;color:#fff;line-height:40px;padding:5px;font-size:80%;font-weight:700;margin:0 0 2px 0}form{max-width:400px;margin:0 auto}label{display:block;margin:0;padding:0}input{display:block;font-size:1em;margin-bottom:1em;width:100%;padding:5px;box-sizing:border-box}input[type=submit]{background:#000;color:#fff;border:0;height:40px}main.book section{border-top:1px solid}footer{border-top:1px solid}@media screen and (min-width:800px){header span{line-height:55px}main.home section{grid-template-columns:repeat(4,1fr);grid-auto-rows:1fr;grid-template-rows:unset}.cat-block:nth-child(1){grid-column-start:1;grid-column-end:2;font-weight:700;line-height:195px}.cat-block:nth-child(3n+2){grid-column-start:2}.cat-block{line-height:195px}main.books dl{padding:0;display:grid;grid-template-columns:1fr 1fr;grid-auto-flow:dense}main.books dt{padding:0 0 0 calc(73px + 1em)}main.books dl>:nth-of-type(odd){grid-column:1}main.books dl>:nth-of-type(even){grid-column:2}main.books dl img{margin:-1em 1em 0 0}}</style></head><body><header><a href="/"><svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="55" height="55" viewBox="0 0 400 400"><path d="M0 200v200h400V0H0v200zm60-68v60l56.3-.2 56.2-.3.5-40c.6-45.8.6-45.5 9.5-57.9 7.7-10.7 19.8-18.1 34.2-20.7 3.2-.6 26.4-.9 57.5-.6 46.5.3 53 .5 58.2 2.1 22.7 6.8 38.1 21.9 46.3 45.6 2.4 7 2.7 9 3.1 29.1.3 19.5.2 22.5-1.7 29.9-5.2 20.7-17 34.9-36.6 44-12.2 5.8-19.5 7-40.7 7-10.1 0-34.8.3-55 .7l-36.8.6V344h-39.3l.6-57 .7-57h-67.5c-58.7 0-68-.2-71.3-1.5-4.9-2.1-8.1-5.2-10.3-10-1.7-3.8-1.9-8.1-1.9-75.3V72h38v60z"/><path d="M219 111.3c-1.9.7-4.4 2.7-5.7 4.6-2.3 3.4-2.3 3.5-2.3 39.8v36.4l54.8-.3 54.7-.3 5.6-2.6c6.5-3.1 11.9-8.2 15.1-14.2 2.1-3.9 2.3-5.4 2.3-22.2 0-17.7-.1-18.1-2.8-24.1-3.4-7.4-8.4-12.5-15.2-15.6-5-2.3-5.2-2.3-54-2.5-36.3-.2-49.9.1-52.5 1z"/></svg></a><nav><a href="https://www.leepenney.com/index.html">Home</a> &gt; <a href="https://www.leepenney.com/tech">Tech</a></nav></header><main class="tech"><article><h1>Avoiding headaches with Go, Docker and fly.io</h1><div class="meta">6 Dec, 2023 | <span class="tag">Tech</span></div><p>I'm putting this here mainly to remind myself in future, but also in case it pops up in a search conducted by a soul as perplexed as I was before it finally clicked.</p><p>I'm new to Go and I took my usual approach of jumping in the deep end rather than starting out simple. Although possibly more so this time (I was on a timeline).</p><p>I got my app working locally, using a single Go module and Sqlite as my database, the app I was building didn't need much.</p><p>I figured Go would offer an easy way to deliver this -- a single file and a single locally hosted database, what could be simpler!</p><p>It would also give me a chance to try fly.io as an option for hosting.The only snag was that because I wanted to use the sqlite database, I had to <a href="https://fly.io/docs/languages-and-frameworks/dockerfile/">deploy using a Dockerfile</a>.</p><p>I've run Docker containers before, very occasionally, usually created by someone else. I vaguely remember writing a Dockerfile at some point too, but this was a different kettle of fish.</p><p><a href="https://www.youtube.com/watch?v=SnSH8Ht3MIc">This video</a> and <a href="https://www.youtube.com/watch?v=p1dwLKAxUxA">this video</a> got me more comfortable with the basics pertaining to Dockerfiles and Go. As did the <a href="https://docs.docker.com/language/golang/build-images/">Docker docs on the subject</a>.</p><p>And that's where I ran into my first issue: go.mod and go.sum.</p><p>I needed those as I was using a <a href="https://github.com/mattn/go-sqlite3">third-party package for the Sqlite driver</a> (why is that not a standard one?) and they provided a way to download the package in the image. Easy enough to generate those (it turns out):</p><p><code>go mod init &lt;module-name&gt;</code><br><code>go mod tidy</code></p><p>Job done, right? Well I assumed it was the third-party package I needed to put in the command. So I ended up with my script stating "import cycle not allowed" and I couldn't find anything to say why.</p><p>The answer is you need to use the name of <em><strong>your</strong></em> module in the init command (or a name of some sort, I used the name of the folder my main.go file was in). Bingo, now I had correct files and it generated a sum, which it had previously failed to do. That took me a long time to figure out.</p><p>One problem down.</p><p>Next was that my main.go file built locally, but wouldn't build properly when done through the flyctl tool.</p><p>More digging highlighted that while my local setup had CGO_ENABLED set to 1, the fly environment defaulted to 0, so I added an ENV line that fixed that.</p><p>It then also needed gcc to run the build (both of these were because of the third-party package). So I needed to add:<br><br></p><div><div><code>RUN apk add --no-cache --update go gcc g++</code></div></div><p>Now we were cooking, only my app still didn't work.</p><p>I was using a multi-stage build process to give me as small an image as possible and that meant my original COPY command needed to be repeated to copy over not just the Go file but the folders containing template files and the database.</p><p>With that done it was on to the fly.io setup.</p><p>Surprisingly, I seemed to configure my fly.toml file correctly first time -- luck rather than anything else. And some <a href="https://fly.io/docs/reference/configuration/">good docs</a> from them to be fair.</p><p>The final Dockerfile that got me working was:<br><br></p><div><div><code># Build stage</code></div><div><code>FROM golang:1.21.4-alpine3.17 AS build-stage</code></div><div><code>ENV GO111MODULE=auto</code></div><div><code>ENV CGO_ENABLED=1</code></div><div><code>ENV GOOS=linux</code></div><div><code>RUN apk add --no-cache --update go gcc g++</code></div><div><code>WORKDIR /app</code></div><br><div><code>COPY go.mod go.sum ./</code></div><div><code>RUN go mod download</code></div><br><div><code>COPY . .</code></div><br><div><code>RUN go build -o main main.go</code></div><br><div><code>VOLUME [ "/data" ]</code></div><br><div><code># Run stage</code></div><div><code>FROM alpine:3.17</code></div><div><code>WORKDIR /app</code></div><div><code>COPY --from=build-stage /app/templates ./templates/</code></div><div><code>COPY --from=build-stage /app/data ./data/</code></div><div><code>COPY --from=build-stage /app/main .</code></div><br><div><code>EXPOSE 80</code></div><br><div><code>CMD ["/app/main"]</code></div></div></article></main><footer><p>&copy; Lee Penney. All rights reserved.</p></footer></body></html>