<!DOCTYPE html><html lang="en-GB"><head><meta charset="utf-8"><title>Voice Controlled Home Automation using Amazon Echo, MQTT and NodeJS &gt; Tech &gt; Lee Penney</title><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="description" content="I have a few power sockets that can be switched wirelessly, mainly Energenie devices triggered by my Raspberry Pi. I&#39;ve had a web interface for ages, and some automation around things like sunrise/"><meta property="og:title" content="Voice Controlled Home Automation using Amazon Echo, MQTT and NodeJS"><meta property="og:description" content="I have a few power sockets that can be switched wirelessly, mainly Energenie devices triggered by my Raspberry Pi. I&#39;ve had a web interface for ages, and some automation around things like sunrise/"><meta property="og:url" content="https://www.leepenney.com/tech/voice-controlled-home-automation-using-amazon-echo-mqtt-and-nodejs.html"><meta property="og:type" content="article"><link rel="canonical" href="https://www.leepenney.com/tech/voice-controlled-home-automation-using-amazon-echo-mqtt-and-nodejs.html"><link rel="icon" href="https://www.leepenney.com/img/favicon.ico" type="image/x-icon"><style>body{color:#212121;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;letter-spacing:.02em;padding:0 20px;margin:0 auto;max-width:800px}a{color:#212121;text-decoration:none}dt{font-weight:700;font-size:1.2em}dt a{display:block;padding:10px 0 5px 0}dd,div.meta{margin:0 0 1em 0;color:#aaa;font-size:90%}code{font-family:monospace;font-size:120%}header{border-bottom:1px solid;padding:20px 0}header:after{content:"";display:table;clear:both}header svg{float:left;margin:0 10px 0 0}header nav,header span{vertical-align:middle}header nav{line-height:55px}header nav a{border-bottom:1px dotted}main{margin:20px 0}main.home section{display:grid;grid-template-columns:1fr 1fr;grid-auto-rows:calc((100vw - 40px)/ 2);column-gap:10px;row-gap:10px;margin:0 0 3em 0;grid-template-rows:2em}.cat-block{display:block;color:#fff;background:#212121;text-decoration:none;text-align:center;line-height:calc((100vw - 40px)/ 2)}.cat-block:nth-child(1){grid-column-start:1;grid-column-end:3;line-height:normal;color:#212121;background:#fff}span.tag{background:#eaedee;display:inline-block;margin:0 7px 0 0;border-radius:5px;padding:0 10px}main.books dl{padding:0 0 0 90px}main.books dd:after{content:"";display:table;clear:both}main.books dl img{height:120px;width:80px;float:left;margin:-1.6em 0 0 -90px}article img{max-width:100%;height:auto}article hr{display:none}article table{border-collapse:collapse;border:none!important;margin:1em auto}article tr{border-bottom:1px dotted}article td,article th{border:none!important;padding:.5em 1em}article li{margin:0 0 1em 0}article a{border-bottom:1px dotted}main.book article img{height:180px;width:120px;display:block;margin:0 1em 0 0;float:left}main.book article p:first-of-type+ul{list-style-type:none;float:left;padding:0;width:120px;margin:1em 1em 1em 0;font-size:90%;clear:left;text-transform:uppercase;text-align:center}main.book article ul a{display:block;background:#000;color:#fff;line-height:40px;padding:5px;font-size:80%;font-weight:700;margin:0 0 2px 0}form{max-width:400px;margin:0 auto}label{display:block;margin:0;padding:0}input{display:block;font-size:1em;margin-bottom:1em;width:100%;padding:5px;box-sizing:border-box}input[type=submit]{background:#000;color:#fff;border:0;height:40px}main.book section{border-top:1px solid}footer{border-top:1px solid}@media screen and (min-width:800px){header span{line-height:55px}main.home section{grid-template-columns:repeat(4,1fr);grid-auto-rows:1fr;grid-template-rows:unset}.cat-block:nth-child(1){grid-column-start:1;grid-column-end:2;font-weight:700;line-height:195px}.cat-block:nth-child(3n+2){grid-column-start:2}.cat-block{line-height:195px}main.books dl{padding:0;display:grid;grid-template-columns:1fr 1fr;grid-auto-flow:dense}main.books dt{padding:0 0 0 calc(73px + 1em)}main.books dl>:nth-of-type(odd){grid-column:1}main.books dl>:nth-of-type(even){grid-column:2}main.books dl img{margin:-1em 1em 0 0}}</style></head><body><header><a href="/"><svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="55" height="55" viewBox="0 0 400 400"><path d="M0 200v200h400V0H0v200zm60-68v60l56.3-.2 56.2-.3.5-40c.6-45.8.6-45.5 9.5-57.9 7.7-10.7 19.8-18.1 34.2-20.7 3.2-.6 26.4-.9 57.5-.6 46.5.3 53 .5 58.2 2.1 22.7 6.8 38.1 21.9 46.3 45.6 2.4 7 2.7 9 3.1 29.1.3 19.5.2 22.5-1.7 29.9-5.2 20.7-17 34.9-36.6 44-12.2 5.8-19.5 7-40.7 7-10.1 0-34.8.3-55 .7l-36.8.6V344h-39.3l.6-57 .7-57h-67.5c-58.7 0-68-.2-71.3-1.5-4.9-2.1-8.1-5.2-10.3-10-1.7-3.8-1.9-8.1-1.9-75.3V72h38v60z"/><path d="M219 111.3c-1.9.7-4.4 2.7-5.7 4.6-2.3 3.4-2.3 3.5-2.3 39.8v36.4l54.8-.3 54.7-.3 5.6-2.6c6.5-3.1 11.9-8.2 15.1-14.2 2.1-3.9 2.3-5.4 2.3-22.2 0-17.7-.1-18.1-2.8-24.1-3.4-7.4-8.4-12.5-15.2-15.6-5-2.3-5.2-2.3-54-2.5-36.3-.2-49.9.1-52.5 1z"/></svg></a><nav><a href="https://www.leepenney.com/index.html">Home</a> &gt; <a href="https://www.leepenney.com/tech">Tech</a></nav></header><main class="features tech vfd"><article><h1>Voice Controlled Home Automation using Amazon Echo, MQTT and NodeJS</h1><div class="meta">2 Dec, 2018 | <span class="tag">Features</span><span class="tag">Tech</span><span class="tag">Vfd</span></div><p>I have a few power sockets that can be switched wirelessly, mainly Energenie devices triggered by my Raspberry Pi. I've had a web interface for ages, and some automation around things like sunrise/sunset, but I'd been meaning to add voice control to save me requiring a device to hand.</p><p>Obviously Alexa is hosted on Amazon's servers, so any command from the Echo was going to outside my own network. I needed to get it back inside, to trigger the code on the Pi, but I wanted to do that without exposing any URLs or potential data breach opportunities.</p><p>I found a few tutorials that showed how to do it by setting up your own Alexa Skill in AWS Lambda, combined with Amazon's IoT option, but this seemed like a lot of effort. Instead, I was trying to find the right combo of services that would knit together. In the end, a combination of <a href="https://ifttt.com">IFTTT</a>, <a href="https://beebotte.com">Beebotte</a> and a custom Node script running on a local machine did the job.</p><h3 id="mcetoc_1e0tn00o60">Integrating with Alexa</h3><p>IFTTT was a simple selection as it already has Amazon Alexa listed as one of the services it integrates with.</p><p>A bit of research also highlighted the ability to accept and hit webhooks. So I could set up an Applet in IFTTT to listen for a command on my Echo and make a call to a URL that included a command.</p><p>To do that, simply select Amazon Alexa for the 'this' part of the Applet, then authorise integration. Once done, pick a "Say a specific phrase" trigger.</p><p><img class="post__image" src="https://www.leepenney.com/img/ifttt_alexa_trigger-opt.jpg" alt="" width="1206" height="687"></p><h3 id="mcetoc_1e0tn00o61">MQTT - Beebotte</h3><p>Originally, the plan was to self-host a script to send a message via XMPP/Jabber when the URL was hit. I currently have a basic bot set-up by way of a Node script connected and listening for messages. Triggering a message using PHP seemed to be a bit of pain, so I turned to MQTT.</p><p>It was something I had been meaning to look into for a while and this proved a useful opportunity.</p><p>I didn't want to self-host. If I put it on my own hardware I was back to the issue of opening ports/making URLs accessible externally. I could have found somewhere to host software, but it would be much easier if I could find a third-party.</p><p>There are a few offering hosted MQTT services, but I needed one that accepted REST calls, and Beebotte did the job. Also nice that it has a <a href="https://beebotte.com/plans">free tier</a>. If I make 100 calls a month I'll be surprised, so I didn't really want a service charging Â£5 a month.</p><p>After opening your account, you need to create a new channel, then a resource inside that channel. You'll also get a token unique token to access these.</p><p><img class="post__image" src="https://www.leepenney.com/img/beebotte_channel_setup-opt.jpg" alt="" width="714" height="413"></p><p>Note that in their API docs, if you're not using one of their libraries, which you won't be, you simply substitute <strong>dev</strong> for your channel name/ref and <strong>res/res1</strong> for resource name, i.e.</p><p><code>https://api.beebotte.com/v1/data/publish/&lt;Your_Channel_Name&gt;/&lt;your_resource_name&gt;</code></p><p>Something else that wasn't clear in the examples in their docs is that you don't need to submit the token in a header, you can pass it as a parameter as well (which is good, as IFTTT can't pass headers):</p><p><code>https://api.beebotte.com/v1/data/publish/&lt;Your_Channel_Name&gt;/&lt;your_resource_name&gt;?token=&lt;your_token&gt;</code></p><p><img class="post__image" src="https://www.leepenney.com/img/ifttt_webhook_setup-opt.jpg" alt="" width="511" height="1026"></p><p>For the "that" part of Applet in IFTTT select Webhooks, then put the URL you created by inserting your channel, resource and token values in the example above into the URL field of the webhook. Set the Method to POST. Set the Content Type to application/json, and then set the Body to:</p><p><code>{"data":"your message here"}</code></p><p>So when Alexa is triggered, IFTTT will publish the message to the channel in Beebotte.</p><h3 id="mcetoc_1e0tn00o62">The final piece - NodeJS</h3><p>Having the message there is fine, but you want to use it to trigger an event. In my case, I had a little internal API that was already set up to make my Pi transmit to my various Energenie sockets.</p><p>I already had a script that watches XMPP for messages, and this isn't very different. I used the <a href="https://www.npmjs.com/package/mqtt">mqtt module</a> and a modified version of the example in Beebotte's docs:</p><p><a href="https://beebotte.com/docs/mqtt">https://beebotte.com/docs/mqtt</a></p><p>The main difference was I wanted to connect to the TLS version, for added transit security, so amended the connection to:</p><p><code>const options = {</code><br><code>port: 8883,</code><br><code>host: 'mqtts://mqtt.beebotte.com',</code><br><code>username: '&lt;your_channel_token&gt;',</code><br><code>password: '',</code><br><code>rejectUnauthorized: false,</code><br><code>keepalive: 60,</code><br><code>reconnectPeriod: 1000 * 1</code><br><code>};</code><br><code>const client = mqtt.connect('mqtts://mqtt.beebotte.com', options);</code></p><p>Note the change to the host as well (mqtts instead of mqtt).</p><p>When something is published to the channel, the Node script picks it up immediately and passes it through to my API, which then executes the relevant command.</p><p>A fairly quick and easy way to get voice control for your own projects without opening all the doors.</p></article></main><footer><p>&copy; Lee Penney. All rights reserved.</p></footer></body></html>